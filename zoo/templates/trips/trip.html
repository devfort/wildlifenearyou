{% extends base %}

{% load thumbnail %}

{% block title %}{{ trip.title }}{% endblock %}

{% block extra_head %}
<script type="text/javascript" src="/static/js/star-select-replace.js"></script>
<script type="text/javascript" src="/static/js/gallery.js"></script>
{% endblock %}

{% block primary_content %}

<h1>{{ trip.compact_title }}</h1>
{% with trip.sightings.all as sightings %}
        {% regroup sightings by place.known_as as sightings_by_place %}
    
        {% with sightings_by_place|length as sl %}
        {% ifequal 1 sl %}
                <p>A trip to {% for place in sightings_by_place %}{% for sighting in place.list|slice:":1" %}           
                        <a href="{% url place sighting.place.country.country_code,sighting.place.slug %}">{{ place.grouper }}</a>
                {% endfor %}{% endfor %} with {{ trip.sightings.count }} animal sighting{{ trip.sightings.count|pluralize }}</p>

                <p class="description">
                {{ trip.description|linebreaks }}
                </p>

                {% for place in sightings_by_place %}
                        <h2>Sighting{{ trip.sightings.count|pluralize }}</h2>
                        <ul>
                                {% for sighting in place.list %}
                                    {% if sighting.species %}
                                        <li><a href="{% url place-species-view sighting.place.country.country_code,sighting.place.slug,sighting.species.slug %}">{{ sighting.species.common_name }}</a></li>
                                    {% else %}
                                        <li>{{ sighting.species_inexact }}</li>
                                    {% endif %}
                                {% endfor %}
                        </ul>
                {% endfor %}
        {% else %}
                <p>A trip with {{ trip.sightings.count }} animal sighting{{ trip.sightings.count|pluralize }}</p>

                <p class="description">
                {{ trip.description }}
                </p>

                <h2>Sighting{{ trip.sightings.count|pluralize }}</h2>
                {% for place in sightings_by_place %}
                        <h3>{% for sighting in place.list|slice:":1" %}<a href="{% url place sighting.place.country.country_code,sighting.place.slug %}">{{ place.grouper }}</a>
                {% endfor %}</h3>
                <p>({{ place.list|length }} sighting{{ place.list|length|pluralize }})</p>

                <ul>
                        {% for sighting in place.list %}
                        {% if sighting.species %}<li><a href="{% url place-species-view sighting.place.country.country_code,sighting.place.slug,sighting.species.slug %}">{{ sighting.species.common_name }}</a></li>
                        {% else %}
                        <li>{{ sighting.species_inexact }}</li>
                        {% endif %}
                        {% endfor %}
                </ul>
                {% endfor %}
        {% endifequal %}
        {% endwith %}
{% endwith %}

<p>Created by <a href="{% url accounts-profile trip.created_by.username %}">{{ trip.created_by }}</a> on {{ trip.created_at|date:"jS F Y" }}</p>

{% if belongs_to_user %}
<p><a href="edit/">Edit this trip</a> | <a href="delete/">Delete this trip</a></p>
{% endif %}

{% endblock %}

{% block secondary_content %}

	<h2>Trip Rating</h2>
	{% if rating.on %}
	<p class="rating" title="{{ rating.on|length }} out of 5 stars">
	{% for i in rating.on %}
	<img src="/static/img/icons/starselect_single.gif" alt="">
	{% endfor %}
	{% for i in rating.off %}
	<img src="/static/img/icons/starselect_off.png" alt="">
	{% endfor %}
	</p>
	{% else %}
	<p>You haven&rsquo;t rated this trip yet; don&rsquo;t worry though, you can do this by editing the trip.</p>
	{% endif %}

        <!-- TODO: Users should see their OWN photos even if they have not 
            yet been moderated, with a visual indication of this e.g. red border
        -->
        {% with trip.visible_photos.count as visible_photo_count %}
        	{% if visible_photo_count %}
                        <h2>Photos</h2>
        		{% ifequal visible_photo_count 1 %}{# Only one photo #}
        			<div class="gallery">
        			{% for photo in trip.visible_photos.all %}
        				<a href="{% url photo photo.created_by.username,photo.id %}"><img src="{% thumbnail photo.photo 150x1000 %}"></a>
        			{% endfor %}
        			</div>
        		{% else %}{# More than one photo #}
        		{% with trip.visible_photos.all|first as chosen %}
        		<div class="gallery">
                		<a href="{% url photo chosen.created_by.username,chosen.id %}"><img src="{% thumbnail chosen.photo 150x1000 %}"></a>
                		<div class="slideshow">
                			<ul id="thumbnails">
        			                {% for photo in trip.visible_photos|slice:":30" %}
        			                {% ifnotequal chosen photo %}
                		                <li><a href="{% url photo photo.created_by.username,photo.id %}"><img src="{% thumbnail photo.photo 75x75 crop %}"></a></li>
                		                {% endifnotequal %}
        			                {% endfor %}
        			        </ul><!-- /#thumbnails -->
        		        </div><!-- /.slideshow -->
        	        </div>
        	        {% endwith %}
        		{% endifequal %}
                {% if belongs_to_user %}<h2>Got any more?</h2>{% endif %}
                {% else %}
                {% if belongs_to_user %}<h2>Take any photos?</h2>{% endif %}
                <h2>Take any photos?</h2>
                {% endif %}
        {% endwith %}
        {% if belongs_to_user %}
        <form enctype="multipart/form-data" action="{{ request.path }}upload/" method="POST">
            <p><input type="file" name="photo" id="id_photo"> <input type="submit" value="Upload"></p>
        </form>
        {% endif %}
{% endblock %}
