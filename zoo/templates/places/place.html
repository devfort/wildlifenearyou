{% extends "base.html" %}

{% block title %}{{ place.known_as }}{% endblock %}

{% block extra_head %}
<script type="text/javascript">
function anyEmptyOnes() {
    return jQuery('#see-more-animals p:visible :text').filter(function() {
        return $(this).val() == '';
    }).length > 0;
}

function unusedSawId() {
    var i = 1;
    var saw_id = 'saw_' + i;
    while ($('#' + saw_id).length) {
        i += 1;
        saw_id = 'saw_' + i;
    }
    return saw_id;
}

jQuery(function($) {
    function setupSawBoxes() {
        $('div#see-more-animals input[name=saw]').unbind('keyup').keyup(
            function() {
                var $this = $(this);
                if ($this.val()) {
                    // Only do something if this is the last empty one
                    if (anyEmptyOnes()) {
                        return;
                    }
                    if (!$this.parent().hasClass('and-a')) {
                        $('div#see-more-animals .and-a').show();
                    } else {
                        // Clone an existing .and-a
                        var and_a = $(
                            'div#see-more-animals .and-a'
                        ).eq(0).clone();
                        var unused_id = unusedSawId();
                        and_a.find('input').val('').attr('id', unused_id);
                        and_a.find('label').attr('for', unused_id);
                        and_a.insertBefore('#see-more-animals :submit');
                        setupSawBoxes();
                    }
                }
            }
        );
    }
    // Set up the I saw a form bit
    if (anyEmptyOnes()) {
        $('div#see-more-animals .and-a').hide()
    }
    setupSawBoxes();
});
</script>
<style type="text/css">
div#see-more-animals {
    background-color: lightblue;
}
div#see-more-animals label {
    width: 5em;
    float: left;
}
div#see-more-animals p {
    margin: 0;
}
</style>
{% endblock %}

{% block content %}

<div id="main_stuff">

<h1>{{ place.known_as }}</h1>
{% if place.url %}
<a href="{{ place.url }}">&raquo; Visit their official website</a>
{% endif %}

<!-- <p class="sub-head">{{ place.legal_name }}</p> -->
<p><address>{{ place.address }}</address></p>

{% if place.phone %}
<p>Phone: {{ place.phone }}</p>
{% endif %}

{% if place.description %}
<p>{{ place.description }}</p>
{% endif %}

<h2>Animals you might see</h2>
{% if species_list %}
<ul id="species_list">
{% for species in species_list %}
	<li><span class="cloud-quad-{{ species.quad }}" title="{{ species.count }} seen"><a href="{{ species.urls.absolute }}">{{ species.common_name }}</a></span></li>
{% endfor %}
</ul>
{% endif %}

<div id="see-more-animals">
    <h3>Did you see more animals?</h3>
    <p>What did you see?</p>
    <form action="{{ request.path }}add-sightings/" method="POST">
        <p><label for="saw_1">I saw a </label><input type="text" name="saw" id="saw_1"></p>
        <p class="and-a"><label for="saw_2">and a </label><input type="text" name="saw" id="saw_2"> (optional)</p>
        <input type="submit" value="Add my animals">
    </form>
</div>

<a href="{% url place-species place.country.country_code,place.slug %}">All species</a>

<h2>Opening times <span class="meta">(times are subject to change)</span></h2>
{% for date_ranges in opening_times %}
	<h3>{{ date_ranges.0|safe }}</h3>

	{% for section_title, days in date_ranges.1.items %} 
	 	{% if section_title %} 
	 	<h4>{{ section_title }}</h4> 
	 	{% endif %} 

	<dl>
	{% for day in days %}
		{% if day %}
			{% if day.name %}
				<dt>{{ day.name }}</dt>
			{% endif %}
			<dd>
				{% if day.closed %}Closed{% endif %}
				{{ day.times }}
			</dd>
		{% endif %}
	{% endfor %}
	</dl>
{% endfor %}
{% endfor %}


<div style="border: dotted 1px #cc0000;">
<p><em>Not using:</em>

{% with place.enclosures.all as enclosures %}
    {% if enclosures %}
        <h2>Enclosures</h2>
        {% for enclosure in enclosures %}
            <h3>{{ enclosure }}</h3>
			{% if enclosure.enclosurespecies_set.all %}
			<ul>
            {% for inhabitant in enclosure.enclosurespecies_set.all %}
                <li>{{ inhabitant.number_of_inhabitants }} &times; <a href="{{ inhabitant.species.urls.absolute }}">{{ inhabitant.species }}</a></li>
            {% endfor %}
			</ul>
			{% else %}
			<p>We don't know which animals live in this enclosure, do you?</p>
			{% endif %}
        {% endfor %}
    {% endif %}
{% endwith %}
</div>

<h2>Price</h2>
{% with place.price.all as prices %}
    {% if prices %}
        {% for price in prices %}
			<p>{{ price.type|title }}: {{ price.currency }}{{ price.value }}
        {% endfor %}
    {% endif %}
{% endwith %}


<h2>Facilities</h2>
<ul>
{% for placefacility in place.place_facilities.all %}
<li><img src="{{ placefacility.facility.icon.url }}">{{ placefacility.desc }}</li>
{% endfor %}
</ul>

<h2>Directions</h2>

{% with place.direction.all as directions %}
    {% if directions %}
	{% for direction in directions %}
    	<h3>By {{ direction.mode }}</h3>
		<p>{{ direction.route }}</p>
	{% endfor %}
    {% endif %}
{% endwith %}

<!-- 
<h2>Events</h2>
-->

<h2>News</h2>

{% with place.news.all as news %}
    {% if news %}
    <h3>News about {{ place.known_as }}</h3>
    <ul>
    {% for story in news %}
        <li>{{ story.story_date|date:"jS M Y" }}: <a href="{{ story.url }}">{{ story.headline }}</a></li>
    {% endfor %}
    </ul>
    {% endif %}
{% endwith %}

<h2>Extras</h2>

<ul>
{% for extra in place.extras.all %}
<li><a href="{{ extra.file.url }}">{{ extra }}</a></li>
{% endfor %}
<li><a href="">Zoo summary sheet</a></li>
</ul>

</div>

<div id="sidebar">

<h2>Rating</h2>

<h2>Photos</h2>

{% for photo in place.visible_photos.all %}
<div>
<a href="{{ photo.urls.absolute }}" title="{{ photo.title }}">{{ photo.photo.thumbnail_tag }}</a> by <a href="{% url accounts-profile photo.created_by.username %}/">{{ photo.created_by|title }}</a>
</div>
{% endfor %}
{% if not user.is_anonymous %}
<p><a href="upload/">Upload a photo you took here!</a></p>
{% endif %}

<h2>Zoo logbook entries</h2>

<ul>
{% for trip in place.most_recent_trips_with_desc|slice:":5" %}
<li>
<blockquote>{{ trip.description|truncatewords:10 }}</blockquote>
<p>&mdash; <a href="{{ trip.created_by.get_profile.urls.absolute }}">{{ trip.created_by }}</a></p>
{% endfor %}
</ul>

<h2>Comments</h2>
{% with place as object %}
    {% include "comments/_comments.html" %}
{% endwith %}

<p class="suggest-changes">
Found incorrect info on this page?
<a href="{{ place.urls.suggest_changes }}">sobebebeb</a>

</div>

{% endblock %}
