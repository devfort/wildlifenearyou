{% extends base %}

{% block title %}Search: {% if what %}&ldquo;{{ what }}&rdquo;{% else %}Everything{% endif %} near {{ location_used.description }}{% endblock %}

{% block extra_head %}
<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key={{ GOOGLE_MAPS_API_KEY }}" type="text/javascript"></script>
<script type="text/javascript">
function showMap() {
    var $ = jQuery;
    var div = $('<div id="gmap"></div>');
    div.css({
        'width': 500,
        'height': 400
    });
    div.insertBefore($('ol:first'));
    window.gmap = new GMap2(div[0]);
    gmap.addControl(new GLargeMapControl());
    gmap.addControl(new GScaleControl());
    gmap.addControl(new GMenuMapTypeControl());
    gmap.setCenter(new GLatLng(37.4419, -122.1419), 13);

    var bounds = new GLatLngBounds();
    $('h4 span.latlon').each(function() {
        var bits = this.title.split(', ');
        var lat = bits[0];
        var lon = bits[1];
        var point = new GLatLng(lat, lon);
        var marker = new GMarker(point);
        bounds.extend(point);
        gmap.addOverlay(marker);
    });
    gmap.setZoom(gmap.getBoundsZoomLevel(bounds));
    gmap.setCenter(bounds.getCenter());

}
</script>
{% endblock %}

{% block content_title %}
<h1>Search: {% if what %}&ldquo;{{ what }}&rdquo;{% else %}Everything{% endif %} near {{ location_used.description }}</h1>
{% endblock %}

{% block search_form %}{% endblock %}

{% block primary_content %}

<form action="/search/" method="GET">
    <div class="container text-container">
        <input type="text" name="what" value="{% if what %}{{ what }}{% else %}Everything{% endif %}" size="20"{% if not what %} class="remove-default"{% endif %}>
        near <input type="text" name="near" value="{{ near }}" size="25">
        <input type="submit" value="Search">
    </div>
</form>

{% if what %}
<p><small>Alternatively, search for
<a href="/search/?q={{ what|urlencode }}">&ldquo;{{ what }}&rdquo; everywhere</a>,
or <a href="/search/?near={{ near|urlencode }}">everything near &ldquo;{{ near }}&rdquo;</a>.</small>
</p>
{% endif %}

{% if locations %}
<p>We are using the location {{ location_used.description }}.</p>
<ul>
    {% for location in locations %}
    <li>Did you mean <a href="/search/?what={{ what|urlencode }};near={{ location.description|urlencode }}">{{ what }} near {{ location.description }}</a>?</li>
    {% endfor %}
</ul>
{% endif %}

{% if not results %}
<p class="notification">I&rsquo;m afraid your search returned no results. Try something else?</p>
{% if request.user.is_staff %}
    <p class="notification">If you&rsquo;re a developer, try running <samp>./manage.py reindex_places</samp></p>
{% endif %}
{% endif %}

{% if results and results_corrected_q %}

<p class="notification">
We couldn&rsquo;t find any results for {{ q }}, so we thought you might like these results for &ldquo;{{ results_corrected_q }}&rdquo;.
</p>

{% endif %}

{% if results %}
    <ol class="place-list">
    {% for place in results %}
    <li>
    {% include "places/_place.html" %}
    </li>
    {% endfor %}
    </ol>

<p><a href="#" onclick="showMap(); return false;">Show on a map</a></p>

{% endif %}
{% if request.user.is_staff %}
    <h4><a class="toggler" href="#debug-results">Debug info (developers only)</a></h4>
    <pre id="debug-results" style="font-size:0.85em">{{ results_info }}</pre>
{% endif %}

{% endblock %}

{% block secondary_content %}

{% if species_results %}
    <h4>Matching species</h4>
    <ol>
    {% for result in species_results %}
        <li><a href="{{ result.get_absolute_url }}">{{ result.common_name }}</a> <i class="scientific">{{ result.latin_name }}</i></li>
    {% endfor %}
    </ol>
{% endif %}
{% if request.user.is_staff %}
    <h4><a class="toggler" href="#debug-species-results">Debug info (developers only)</a></h4>
    <pre id="debug-species-results" style="font-size:0.85em">{{ species_results_info }}</pre>
{% endif %}

{% endblock %}
